name: CI/CD Pipelinename: CI/CD Pipeline



on:on:

  pull_request:  pull_request:

    branches:    branches:

      - Test      - Test

  push:  push:

    branches:    branches:

      - main      - main

      - Dev      - Dev



permissions:# Add this permissions section

  contents: writepermissions:

  pull-requests: write  contents: write

  actions: read  pull-requests: write

  actions: read

jobs:

  test:jobs:

    runs-on: ubuntu-latest  test:

    runs-on: ubuntu-latest

    steps:

      - name: Checkout repository    steps:

        uses: actions/checkout@v4      - name: Checkout repository

        with:        uses: actions/checkout@v4

          fetch-depth: 0        with:

          fetch-depth: 0

      - name: Set up Node.js

        uses: actions/setup-node@v4      - name: Set up Node.js

        with:        uses: actions/setup-node@v4

          node-version: '18'        with:

          cache: 'npm'          node-version: '18'

          cache: 'npm'

      - name: Install dependencies

        run: npm ci      - name: Install dependencies

        run: npm ci

      - name: Run Jest tests

        run: npm test      - name: Run Jest tests

        run: npm test

  build-and-deploy:

    runs-on: ubuntu-latest  build-and-deploy:

    needs: test    runs-on: ubuntu-latest

    if: github.ref == 'refs/heads/Dev' && github.event_name == 'push'    needs: test

        if: github.ref == 'refs/heads/Dev' && github.event_name == 'push'

    steps:    

      - name: Checkout repository    steps:

        uses: actions/checkout@v4      - name: Checkout repository

        with:        uses: actions/checkout@v4

          fetch-depth: 0        with:

          token: ${{ secrets.GITHUB_TOKEN }}          fetch-depth: 0

          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git

        run: |      - name: Configure Git

          git config --global user.name 'github-actions[bot]'        run: |

          git config --global user.email 'github-actions[bot]@users.noreply.github.com'          git config --global user.name 'github-actions[bot]'

          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # Set up Docker

      - name: Set up Docker Buildx      # Set up Docker

        uses: docker/setup-buildx-action@v3      - name: Set up Docker Buildx

        uses: docker/setup-buildx-action@v3

      # Login to Docker Hub

      - name: Login to Docker Hub      # Login to Docker Hub

        uses: docker/login-action@v3      - name: Login to Docker Hub

        with:        uses: docker/login-action@v3

          username: ${{ secrets.DOCKER_USERNAME }}        with:

          password: ${{ secrets.DOCKER_PASSWORD }}          username: ${{ secrets.DOCKER_USERNAME }}

          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build and push Docker image with SHA and latest tags

      - name: Build and push Docker image      # Build and push Docker image

        uses: docker/build-push-action@v5      - name: Build and push Docker image

        with:        uses: docker/build-push-action@v5

          context: .        with:

          push: true          context: .

          tags: |          push: true

            ${{ secrets.DOCKER_USERNAME }}/my-custom-nginx:${{ github.sha }}          tags: |

            ${{ secrets.DOCKER_USERNAME }}/my-custom-nginx:latest            ${{ secrets.DOCKER_USERNAME }}/my-custom-nginx:${{ github.sha }}

          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/my-custom-nginx:latest            ${{ secrets.DOCKER_USERNAME }}/my-custom-nginx:latest

          cache-to: type=inline

      # Update Kubernetes manifest

      # Update Kubernetes manifest with new image SHA      - name: Update Kubernetes manifest

      - name: Update Kubernetes manifest        run: |

        run: |          # Update image tag in deployment.yaml

          sed -i "s|image: .*/my-custom-nginx:.*|image: ${{ secrets.DOCKER_USERNAME }}/my-custom-nginx:${{ github.sha }}|g" kubernetes/deployment.yaml          sed -i "s|image: ${{ secrets.DOCKER_USERNAME }}/my-custom-nginx:.*|image: ${{ secrets.DOCKER_USERNAME }}/my-custom-nginx:${{ github.sha }}|g" kubernetes/deployment.yaml

          # Add a timestamp annotation to force rollout even if image looks the same

      # Commit updated manifest to Dev branch          sed -i "s|kubernetes.io/change-cause:.*|kubernetes.io/change-cause: \"Updated $(date -u +'%Y-%m-%dT%H:%M:%SZ')\"|g" kubernetes/deployment.yaml

      - name: Commit updated manifest to Dev

        run: |      - name: Commit and push updated manifest (GitOps)

          git add kubernetes/deployment.yaml        run: |

          if git diff --cached --quiet; then          git add kubernetes/deployment.yaml

            echo "No changes to commit"          git commit -m "chore: update image to ${{ github.sha }}" || echo "No changes"

          else          # Don't push to Dev

            git commit -m "chore: update image to ${{ github.sha }} [skip ci]"

            git push origin Dev      - name: Merge Dev into Test branch

          fi        run: |

          git fetch origin

      # Merge Dev into Test branch          git checkout Test 2>/dev/null || git checkout -b Test

      - name: Merge Dev into Test branch          git merge origin/Dev --no-ff -m "Auto-merge: Deploy Dev to Test"

        run: |          git push origin Test  # Only push to Test, not Dev

          git fetch origin Test

          git checkout Test 2>/dev/null || git checkout -b Test origin/Test      # Create deployment comment

          git merge origin/Dev --no-ff -m "ci: auto-merge Dev to Test after successful tests and build [skip ci]"      - name: Create deployment comment

          git push origin Test        uses: actions/github-script@v7

        with:

      # Trigger ArgoCD sync (optional - only if ArgoCD is set up)          script: |

      - name: Trigger ArgoCD sync            const { owner, repo } = context.repo;

        if: ${{ secrets.ARGOCD_SERVER != '' }}            const sha = context.sha;

        run: |            const shortSha = sha.substring(0, 8);

          # Install ArgoCD CLI            

          curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64            await github.rest.repos.createCommitComment({

          chmod +x /usr/local/bin/argocd              owner,

                        repo,

          # Login to ArgoCD              commit_sha: sha,

          argocd login ${{ secrets.ARGOCD_SERVER }} --username admin --password ${{ secrets.ARGOCD_PASSWORD }} --insecure              body: `üöÄ **Deployment Triggered!**

                      

          # Force sync the application            ‚úÖ Tests passed on Dev branch

          argocd app sync minikubetest-app --force            üê≥ Docker image built and pushed to Docker Hub

                      üì¶ Code automatically merged to Test branch

          # Wait for sync to complete            

          argocd app wait minikubetest-app --timeout 300 --health            **Docker Image Details:**

            - Repository: ${{ secrets.DOCKER_USERNAME }}/my-custom-nginx

      # Create deployment summary comment            - Tags: latest, ${shortSha}

      - name: Create deployment comment            - Full image: ${{ secrets.DOCKER_USERNAME }}/my-custom-nginx:${sha}

        uses: actions/github-script@v7            - Build #: ${{ github.run_number }}

        with:            

          script: |            **Next Steps:**

            const { owner, repo } = context.repo;            Pull and deploy the new image in your Kubernetes cluster!`

            const sha = context.sha;            });
            const shortSha = sha.substring(0, 8);
            
            await github.rest.repos.createCommitComment({
              owner,
              repo,
              commit_sha: sha,
              body: `üöÄ **Deployment Complete!**
            
            ‚úÖ Tests passed on Dev branch
            üê≥ Docker image built and pushed to Docker Hub
            üì¶ Code automatically merged to Test branch
            üîÑ ArgoCD synced and deployed new image
            
            **Docker Image Details:**
            - Repository: ${{ secrets.DOCKER_USERNAME }}/my-custom-nginx
            - Tags: \`latest\`, \`${shortSha}\`
            - Full image: \`${{ secrets.DOCKER_USERNAME }}/my-custom-nginx:${sha}\`
            - Build #: ${{ github.run_number }}
            
            **Deployment Status:**
            ‚ú® Your application is now running with the latest image in your Kubernetes cluster!`
            });
