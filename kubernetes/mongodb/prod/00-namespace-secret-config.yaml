# MongoDB Production Namespace, Secrets, and ConfigMaps
---
apiVersion: v1
kind: Namespace
metadata:
  name: mongodb-prod
  labels:
    name: mongodb-prod
    environment: production

---
# Secret for MongoDB root credentials
apiVersion: v1
kind: Secret
metadata:
  name: mongodb-secret
  namespace: mongodb-prod
type: Opaque
stringData:
  MONGO_INITDB_ROOT_USERNAME: admin
  MONGO_INITDB_ROOT_PASSWORD: .env MONGODB_PROD_PASSWORD
  MONGO_REPLICA_SET_KEY: .env MONGODB_PROD_SET_KEY

---
# ConfigMap for MongoDB initialization scripts
apiVersion: v1
kind: ConfigMap
metadata:
  name: mongodb-init-scripts
  namespace: mongodb-prod
data:
  init-configsvr.sh: |
    #!/bin/bash
    if [ ! -f /data/db/mongod.lock ]; then
      echo "First run - initializing config server replica set"
      mongod --configsvr --replSet rs-config --bind_ip_all &
      sleep 5
      mongosh --eval 'rs.initiate({
        _id: "rs-config",
        configsvr: true,
        members: [
          { _id: 0, host: "mongo-config-0.mongo-config-svc.mongodb-prod.svc.cluster.local:27017" },
          { _id: 1, host: "mongo-config-1.mongo-config-svc.mongodb-prod.svc.cluster.local:27017" },
          { _id: 2, host: "mongo-config-2.mongo-config-svc.mongodb-prod.svc.cluster.local:27017" }
        ]
      })'
    fi

  init-shard1.sh: |
    #!/bin/bash
    if [ ! -f /data/db/mongod.lock ]; then
      echo "First run - initializing shard1 replica set"
      mongod --shardsvr --replSet rs-shard1 --bind_ip_all &
      sleep 5
      mongosh --eval 'rs.initiate({
        _id: "rs-shard1",
        members: [
          { _id: 0, host: "mongo-shard1-0.mongo-shard1-svc.mongodb-prod.svc.cluster.local:27017" },
          { _id: 1, host: "mongo-shard1-1.mongo-shard1-svc.mongodb-prod.svc.cluster.local:27017" }
        ]
      })'
    fi

  init-shard2.sh: |
    #!/bin/bash
    if [ ! -f /data/db/mongod.lock ]; then
      echo "First run - initializing shard2 replica set"
      mongod --shardsvr --replSet rs-shard2 --bind_ip_all &
      sleep 5
      mongosh --eval 'rs.initiate({
        _id: "rs-shard2",
        members: [
          { _id: 0, host: "mongo-shard2-0.mongo-shard2-svc.mongodb-prod.svc.cluster.local:27017" },
          { _id: 1, host: "mongo-shard2-1.mongo-shard2-svc.mongodb-prod.svc.cluster.local:27017" }
        ]
      })'
    fi
