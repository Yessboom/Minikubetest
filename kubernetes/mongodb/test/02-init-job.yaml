apiVersion: v1
kind: Pod
metadata:
  name: mongo-init-test
  namespace: mongodb-test
spec:
  serviceAccountName: default
  containers:
  - name: mongosh
    image: mongo:7.0
    command:
    - /bin/bash
    - -c
    - |
      sleep 30
      echo "Initializing Config Server Replica Set..."
      mongosh --host mongo-config-0.mongo-config-svc.mongodb-test.svc.cluster.local:27017 --eval '
        rs.initiate({
          _id: "rs-config",
          configsvr: true,
          members: [
            {_id: 0, host: "mongo-config-0.mongo-config-svc.mongodb-test.svc.cluster.local:27017"},
            {_id: 1, host: "mongo-config-1.mongo-config-svc.mongodb-test.svc.cluster.local:27017"},
            {_id: 2, host: "mongo-config-2.mongo-config-svc.mongodb-test.svc.cluster.local:27017"}
          ]
        })
      '
      
      sleep 10
      echo "Initializing Shard 1 Replica Set..."
      mongosh --host mongo-shard1-0.mongo-shard1-svc.mongodb-test.svc.cluster.local:27017 --eval '
        rs.initiate({
          _id: "rs-shard1",
          members: [
            {_id: 0, host: "mongo-shard1-0.mongo-shard1-svc.mongodb-test.svc.cluster.local:27017"},
            {_id: 1, host: "mongo-shard1-1.mongo-shard1-svc.mongodb-test.svc.cluster.local:27017"}
          ]
        })
      '
      
      sleep 10
      echo "Initializing Shard 2 Replica Set..."
      mongosh --host mongo-shard2-0.mongo-shard2-svc.mongodb-test.svc.cluster.local:27017 --eval '
        rs.initiate({
          _id: "rs-shard2",
          members: [
            {_id: 0, host: "mongo-shard2-0.mongo-shard2-svc.mongodb-test.svc.cluster.local:27017"},
            {_id: 1, host: "mongo-shard2-1.mongo-shard2-svc.mongodb-test.svc.cluster.local:27017"}
          ]
        })
      '
      
      sleep 10
      echo "Adding shards to cluster..."
      mongosh --host mongos-0.mongodb-test.svc.cluster.local:27017 --eval '
        sh.addShard("rs-shard1/mongo-shard1-0.mongo-shard1-svc.mongodb-test.svc.cluster.local:27017")
      '
      
      sleep 5
      mongosh --host mongos-0.mongodb-test.svc.cluster.local:27017 --eval '
        sh.addShard("rs-shard2/mongo-shard2-0.mongo-shard2-svc.mongodb-test.svc.cluster.local:27017")
      '
      
      echo "Cluster initialization complete!"
  restartPolicy: Never
